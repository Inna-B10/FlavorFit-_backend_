model ShoppingList {
  listId String @id @default(cuid()) @map("list_id")

  user   User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  userId String @unique @map("user_id")

  listItems ShoppingListItem[]
  recipes   ShoppingListRecipe[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("shopping_lists")
}

model ShoppingListItem {
  listItemId String @id @default(cuid()) @map("list_item_id")

  // aggregated required amount across all added recipes
  requiredAmount Decimal    @map("required_amount") @db.Decimal(10, 3)
  recipeUnit     RecipeUnit @map("recipe_unit")

  // user control
  isChecked Boolean @default(false) @map("is_checked")

  cartRequirements CartItemRequirement[]

  // source
  sources ShoppingListItemSource[]

  listId String       @map("list_id")
  list   ShoppingList @relation(fields: [listId], references: [listId], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [productId])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // aggregate by product + recipeUnit (avoid mixing PIECE and GRAM in one row)
  @@unique([listId, productId, recipeUnit])
  @@map("shopping_list_items")
}

model ShoppingListItemSource {
  listItemSourceId String @id @default(cuid()) @map("list_item_source_id")

  listItemId String           @map("list_item_id")
  listItem   ShoppingListItem @relation(fields: [listItemId], references: [listItemId], onDelete: Cascade)

  recipeId String @map("recipe_id")
  recipe   Recipe @relation(fields: [recipeId], references: [recipeId], onDelete: Cascade)

  // which recipe-ingredients version was used when creating this source
  ingredientsVersionUsed Int @default(1) @map("ingredients_version_used")

  // snapshot of what this recipe contributed (so later recipe edits won't break the list)
  amount     Decimal    @db.Decimal(10, 3)
  recipeUnit RecipeUnit @map("recipe_unit")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // one recipe contributes once per ShoppingListItem row
  @@unique([listItemId, recipeId])
  @@map("shopping_list_item_sources")
}

model ShoppingListRecipe {
  listRecipeId String @id @default(cuid()) @map("list_recipe_id")

  listId String       @map("list_id")
  list   ShoppingList @relation(fields: [listId], references: [listId], onDelete: Cascade)

  recipeId String @map("recipe_id")
  recipe   Recipe @relation(fields: [recipeId], references: [recipeId], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // prevents adding the same recipe twice
  @@unique([listId, recipeId])
  @@map("shopping_list_recipes")
}
